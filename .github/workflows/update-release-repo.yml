name: Update Release Repo on New Release

on:
  repository_dispatch:
    types: [new-release]
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Repository name that released'
        required: true
      release_tag:
        description: 'Release tag'
        required: true

jobs:
  update-submodule:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout release-repo
        uses: actions/checkout@v4
        with:
          repository: Keyla-TTT/Keyla-RELEASE
          token: ${{ secrets.PAT_TOKEN }}
          submodules: true

      - name: Update submodule to new release tag
        run: |
          REPO_NAME="${{ github.event.client_payload.repository_name || github.event.inputs.repository_name }}"
          TAG_NAME="${{ github.event.client_payload.release_tag || github.event.inputs.release_tag }}"

          echo "Updating repository: $REPO_NAME to version: $TAG_NAME"

          # Verify existence of the submodule directory
          echo "Available directories:"
          ls -la

          # Navigate to the correct submodule directory
          if [ "$REPO_NAME" = "Keyla-API" ] && [ -d "Keyla-API" ]; then
            cd "Keyla-API"
            echo "Entered in Keyla-API directory"
          elif [ "$REPO_NAME" = "Keyla-CLI" ] && [ -d "Keyla-CLI" ]; then
            cd "Keyla-CLI"
            echo "Entered in Keyla-CLI directory"
          elif [ "$REPO_NAME" = "Keyla-REPORT" ] && [ -d "Keyla-REPORT" ]; then
            cd "Keyla-REPORT"
            echo "Entered in the Keyla-REPORT directory"
          else
            echo "Error: Directory $REPO_NAME not found"
            exit 1
          fi

          # Checkout from the tag
          git fetch --tags
          git checkout "$TAG_NAME"
          cd ..

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update $REPO_NAME to $TAG_NAME"
          git push